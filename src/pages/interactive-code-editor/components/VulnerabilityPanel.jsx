import React, { useState } from 'react';
import Icon from '../../../components/AppIcon';
import Button from '../../../components/ui/Button';

const VulnerabilityPanel = ({ 
  vulnerabilities = [], 
  isScanning = false,
  onRescan,
  className = "" 
}) => {
  const [selectedVuln, setSelectedVuln] = useState(null);
  const [filter, setFilter] = useState('all');

  const mockVulnerabilities = [
    {
      id: 1,
      type: 'SQL Injection',
      severity: 'high',
      line: 15,
      column: 23,
      message: 'Potential SQL injection vulnerability detected',
      description: `The code uses string concatenation to build SQL queries, which can lead to SQL injection attacks. User input is directly concatenated into the SQL query without proper sanitization or parameterization.`,
      suggestion: `Use parameterized queries or prepared statements instead:\n\n// Vulnerable code:\nquery = "SELECT * FROM users WHERE id = " + userId;\n\n// Secure code:\nquery = "SELECT * FROM users WHERE id = ?";\nstmt.setString(1, userId);`,
      cweId: 'CWE-89',
      resources: [
        'OWASP SQL Injection Prevention',
        'Parameterized Queries Guide',
        'Database Security Best Practices'
      ]
    },
    {
      id: 2,
      type: 'Cross-Site Scripting (XSS)',
      severity: 'medium',
      line: 8,
      column: 12,
      message: 'Potential XSS vulnerability in user input handling',
      description: `User input is being directly inserted into the DOM without proper sanitization, which could allow malicious scripts to be executed in the user's browser.`,
      suggestion: `Sanitize user input before displaying:\n\n// Vulnerable code:\nelement.innerHTML = userInput;\n\n// Secure code:\nelement.textContent = userInput;\n// or use a sanitization library`,
      cweId: 'CWE-79',
      resources: [
        'XSS Prevention Cheat Sheet','Content Security Policy Guide','Input Validation Techniques'
      ]
    },
    {
      id: 3,
      type: 'Insecure Randomness',severity: 'low',line: 22,column: 8,message: 'Using Math.random() for security-sensitive operations',
      description: `Math.random() is not cryptographically secure and should not be used for generating tokens, passwords, or other security-sensitive values.`,
      suggestion: `Use cryptographically secure random number generation:\n\n// Vulnerable code:\nconst token = Math.random().toString(36);\n\n// Secure code:\nconst crypto = require('crypto');\nconst token = crypto.randomBytes(32).toString('hex');`,
      cweId: 'CWE-338',
      resources: [
        'Cryptographic Random Number Generation','Secure Token Generation','Node.js Crypto Module Guide'
      ]
    }
  ];

  const displayVulns = vulnerabilities?.length > 0 ? vulnerabilities : mockVulnerabilities;

  const filteredVulns = displayVulns?.filter(vuln => {
    if (filter === 'all') return true;
    return vuln?.severity === filter;
  });

  const getSeverityColor = (severity) => {
    switch (severity) {
      case 'high': return 'text-error bg-error/10 border-error/20';
      case 'medium': return 'text-warning bg-warning/10 border-warning/20';
      case 'low': return 'text-muted-foreground bg-muted border-border';
      default: return 'text-muted-foreground bg-muted border-border';
    }
  };

  const getSeverityIcon = (severity) => {
    switch (severity) {
      case 'high': return 'AlertTriangle';
      case 'medium': return 'AlertCircle';
      case 'low': return 'Info';
      default: return 'Info';
    }
  };

  const severityCounts = {
    high: displayVulns?.filter(v => v?.severity === 'high')?.length,
    medium: displayVulns?.filter(v => v?.severity === 'medium')?.length,
    low: displayVulns?.filter(v => v?.severity === 'low')?.length
  };

  return (
    <div className={`bg-card border border-border rounded-lg overflow-hidden ${className}`}>
      {/* Panel Header */}
      <div className="bg-muted border-b border-border p-4">
        <div className="flex items-center justify-between">
          <div className="flex items-center space-x-3">
            <Icon name="Shield" size={20} className="text-primary" />
            <h3 className="text-lg font-semibold text-foreground">
              Security Analysis
            </h3>
            {isScanning && (
              <div className="flex items-center space-x-2">
                <div className="w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
                <span className="text-sm text-muted-foreground">Scanning...</span>
              </div>
            )}
          </div>
          
          <Button
            variant="outline"
            size="sm"
            onClick={onRescan}
            disabled={isScanning}
            iconName="RefreshCw"
            iconPosition="left"
          >
            Rescan
          </Button>
        </div>

        {/* Severity Summary */}
        <div className="flex items-center space-x-4 mt-3">
          <div className="flex items-center space-x-2">
            <div className="w-3 h-3 bg-error rounded-full"></div>
            <span className="text-sm text-muted-foreground">
              High: {severityCounts?.high}
            </span>
          </div>
          <div className="flex items-center space-x-2">
            <div className="w-3 h-3 bg-warning rounded-full"></div>
            <span className="text-sm text-muted-foreground">
              Medium: {severityCounts?.medium}
            </span>
          </div>
          <div className="flex items-center space-x-2">
            <div className="w-3 h-3 bg-muted-foreground rounded-full"></div>
            <span className="text-sm text-muted-foreground">
              Low: {severityCounts?.low}
            </span>
          </div>
        </div>
      </div>
      {/* Filter Tabs */}
      <div className="border-b border-border">
        <div className="flex">
          {['all', 'high', 'medium', 'low']?.map((severity) => (
            <button
              key={severity}
              onClick={() => setFilter(severity)}
              className={`px-4 py-2 text-sm font-medium border-b-2 transition-fast ${
                filter === severity
                  ? 'border-primary text-primary bg-primary/5' :'border-transparent text-muted-foreground hover:text-foreground hover:bg-muted'
              }`}
            >
              {severity === 'all' ? 'All Issues' : `${severity?.charAt(0)?.toUpperCase() + severity?.slice(1)}`}
              {severity !== 'all' && (
                <span className="ml-1 text-xs">
                  ({severityCounts?.[severity]})
                </span>
              )}
            </button>
          ))}
        </div>
      </div>
      {/* Vulnerabilities List */}
      <div className="max-h-96 overflow-y-auto">
        {filteredVulns?.length === 0 ? (
          <div className="p-8 text-center">
            <Icon name="CheckCircle" size={48} className="text-success mx-auto mb-4" />
            <h4 className="text-lg font-medium text-foreground mb-2">
              No Security Issues Found
            </h4>
            <p className="text-muted-foreground">
              Your code looks secure! Keep following best practices.
            </p>
          </div>
        ) : (
          <div className="divide-y divide-border">
            {filteredVulns?.map((vuln) => (
              <div
                key={vuln?.id}
                className="p-4 hover:bg-muted/50 cursor-pointer transition-fast"
                onClick={() => setSelectedVuln(selectedVuln === vuln?.id ? null : vuln?.id)}
              >
                <div className="flex items-start space-x-3">
                  <Icon 
                    name={getSeverityIcon(vuln?.severity)} 
                    size={20} 
                    className={getSeverityColor(vuln?.severity)?.split(' ')?.[0]} 
                  />
                  
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center justify-between">
                      <h4 className="text-sm font-medium text-foreground truncate">
                        {vuln?.type}
                      </h4>
                      <div className="flex items-center space-x-2">
                        <span className={`px-2 py-1 text-xs font-medium rounded-full border ${getSeverityColor(vuln?.severity)}`}>
                          {vuln?.severity?.toUpperCase()}
                        </span>
                        <span className="text-xs text-muted-foreground">
                          Line {vuln?.line}
                        </span>
                      </div>
                    </div>
                    
                    <p className="text-sm text-muted-foreground mt-1">
                      {vuln?.message}
                    </p>

                    {/* Expanded Details */}
                    {selectedVuln === vuln?.id && (
                      <div className="mt-4 space-y-4 border-t border-border pt-4">
                        <div>
                          <h5 className="text-sm font-medium text-foreground mb-2">
                            Description
                          </h5>
                          <p className="text-sm text-muted-foreground">
                            {vuln?.description}
                          </p>
                        </div>

                        <div>
                          <h5 className="text-sm font-medium text-foreground mb-2">
                            Suggested Fix
                          </h5>
                          <pre className="text-xs bg-muted p-3 rounded-md overflow-x-auto font-data">
                            {vuln?.suggestion}
                          </pre>
                        </div>

                        <div>
                          <h5 className="text-sm font-medium text-foreground mb-2">
                            Learning Resources
                          </h5>
                          <ul className="space-y-1">
                            {vuln?.resources?.map((resource, index) => (
                              <li key={index} className="text-sm text-primary hover:underline cursor-pointer">
                                â€¢ {resource}
                              </li>
                            ))}
                          </ul>
                        </div>

                        <div className="flex items-center justify-between pt-2 border-t border-border">
                          <span className="text-xs text-muted-foreground">
                            CWE ID: {vuln?.cweId}
                          </span>
                          <Button
                            variant="outline"
                            size="sm"
                            iconName="ExternalLink"
                            iconPosition="right"
                          >
                            Learn More
                          </Button>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

export default VulnerabilityPanel;